<head>
  <link rel='stylesheet' href='/stylesheets/style2.css' />
  <style>
    body {
      background-color: #3bd428;
      font-family: 'Roboto Condensed', sans-serif;
      color: #262626;
      margin: 5% 0;
    }

    button {
      width: 100%;
      margin-top: 10px;
      padding: 10px;
      border: none;
      border-radius: 30px;
      background: #de991c;
      color: #fff;
      font-size: 15px;
      font-weight: bold;
    }

    button:hover {
      cursor: pointer;
      background: #3bd428;
    }

    .error {
      color: #de991c;
      padding-left: 23%;
    }

    .address {
      width: 15%;
      border-radius: 9px;
      margin: 3px;
      height: 38px;
      background-color: #de991c;
      color: #fff;
    }
  </style>
</head>

<body>

  <div class="container">
    <div class="title">
      <h2>Product Order Form</h2>
    </div>

    <form id="form">
      <div class="d-flex">
        <div class="frm" action="" method="">
          <input type="hidden" name="userid" value="{{user._id}}">
          <label>
            <span>Select Address <span>*</span></span>
            <input type="button" value="Address1" class="address" onclick="findAdd('{{user._id}}','address1')">
            <input type="button" value="Address2" class="address" onclick="findAdd('{{user._id}}','address2')">
            <input type="button" value="Address3" class="address" onclick="findAdd('{{user._id}}','address3')">
            <a href="/users/manageAddress"><input type="button" value="Manage Address"
                style=" width: 20%; border-radius: 9px;margin: 3px; height: 38px; background-color: #3bd428;color: #fff;"></a>
          </label>
          <label>
            <span class="fname">First Name <span>*</span></span>
            <input type="text" id="fname" name="fname" value="">
          </label>
          <label>
            <span class="lname">Last Name <span>*</span></span>
            <input type="text" id="lname" name="lname" value="">
          </label>
          <label>
            <span>Country <span>*</span></span>
            <input type="text" id="country" name="country" value="">
          </label>
          </label>
          <label>
            <span>HouseName/No <span>*</span></span>
            <input type="text" id="housename" name="address" value="">
          </label>
          <label>
            <span>Town / City <span>*</span></span>
            <input type="text" id="city" name="city" value="">
          </label>
          <label>
            <span>State / County <span>*</span></span>
            <input type="text" id="state" name="state" value="">
          </label>
          <label>
            <span>Postcode / ZIP <span>*</span></span>
            <input type="text" id="pincode" name="pincode" value="">
          </label>
          <label>
            <span>Mobile <span>*</span></span>
            <input type="tel" id="mobile" name="mobile" value="">
          </label>
          <label>
            <span>Email Address <span>*</span></span>
            <input type="email" id="mail" name="mail" value="">
          </label>
        </div>
        <div class="Yorder">
          <table>
            <tr>
              <th colspan="2">Your order</th>
            </tr>
            <tr>
              <td>Subtotal</td>
              <td>Rs.{{total}}</td>
              <input type="hidden" name="total" value="{{total}}">
            </tr>
            <tr>
              <td>Shipping</td>
              <td>Free shipping</td>
            </tr>
          </table><br>
          <div>
            <input type="radio" name="payment_method" checked value="COD"> Cash on Delivery
          </div>
          <div>
            <input type="radio" name="payment_method" value="razorpay"> Razorpay <span>
              <img src="/images/Razorpaay.png" alt="" width="50">
            </span>
          </div>
          <div>
            <input type="radio" name="payment_method" value="paypal"> Paypal <span>
              <img src="https://www.logolynx.com/images/logolynx/c3/c36093ca9fb6c250f74d319550acac4d.jpeg" alt=""
                width="50">
            </span>
          </div>
          <button name="submit" value="submit">Checkout</button>
        </div><!-- Yorder -->
      </div>
    </form>
  </div>

  <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
    integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
    crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
    integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
    crossorigin="anonymous"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.19.3/dist/jquery.validate.js"></script>

  <script>
    jQuery.validator.addMethod("noSpace", function (value, element) {
      return value == '' || value.trim().length != 0;
    }, "No space please and don't leave it empty");
    jQuery.validator.addMethod("customEmail", function (value, element) {
      return this.optional(element) || /^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/.test(value);
    }, "Please enter valid email address!");
    $.validator.addMethod("numeric", function (value, element) {
      return this.optional(element) || value == value.match(/^[0-9]+$/);
    }, "Numbers Only");
    $.validator.addMethod("alphanumeric", function (value, element) {
      return this.optional(element) || value == value.match(/^[a-zA-Z\s]+$/);
    }, "Letters only");

    var $registrationForm = $("#form");

    if ($registrationForm.length) {
      $registrationForm.validate({
        rules: {
          fname: {
            required: true,
            minlength: 4,
            alphanumeric: true
          },
          lname: {
            required: true,
            minlength: 4,
            alphanumeric: true
          },
          country: {
            minlength: 4,
            required: true,
            alphanumeric: true
          },
          city: {
            minlength: 4,
            required: true,
            alphanumeric: true
          },
          state: {
            minlength: 4,
            required: true,
            alphanumeric: true
          },
          pincode: {
            minlength: 4,
            required: true,
            numeric: true,
          },
          address: {
            required: true,
            minlength: 4,
          },
          mail: {
            required: true,
            customEmail: true
          },
          mobile: {
            required: true,
            minlength: 10,
            maxlength: 10,
            numeric: true,
            noSpace: true
          },
          payment_method: {
            required: true,
          },
          pass: {
            required: true,
            minlength: 4,
            maxlength: 10
          },
          confirm: {
            required: true
          },
          content: {
            required: true
          },
          pname: {
            required: true,
            minlength: 3,
          },
          category: {
            required: true,
          },
          price: {
            required: true,
            numeric: true,
          },
          discription: {
            required: true,
          },
          image: {
            required: true,

          },
          cname: {
            required: true,
            minlength: 4,
            alphanumeric: true
          }
        },
        messages: { //error message for the required field
          fname: {
            required: 'Please Enter Your First Name',
            alphanumeric: 'Enter Only Charactors',
            minlength: 'Enter minimum 4 charractors',
          },
          lname: {
            required: 'Please Enter Your Last Name',
            alphanumeric: 'Enter Only Charactors',
            minlength: 'Enter minimum 4 charractors',
          },
          country: {
            required: 'Please Enter Your Country Name',
            alphanumeric: 'Enter Only Charactors',
            minlength: 'Enter minimum 4 charractors',
          },
          city: {
            minlength: 'Enter minimum 4 charractors',
            required: 'Please Enter Your City Name',
            alphanumeric: 'Enter Only Charactors',
          },
          state: {
            minlength: 'Enter minimum 4 charractors',
            required: 'Please Enter Your State Name',
            alphanumeric: 'Enter Only Charactors',
          },
          pincode: {
            minlength: 'Enter minimum 4 charractors',
            required: 'Please Enter Your Pincode',
          },
          address: {
            required: 'Please Enter Your Address',
            minlength: 'Enter minimum 4 charractors',
          },
          mail: {
            required: 'Please Enter Your mail id',
            alphanumeric: 'Please Enter only charractors'
          },
          mobile: {
            required: 'Please Enter  Your Phone Number',
            maxlength: 'Enter only 10 numbers',
            minlength: 'Enter minimum 10 numbers'
          },
          payment_method: {
            required: 'Please select any payment method',
          },
          pass: {
            required: 'Please Enter Your Password',
            maxlength: 'Enter only 10 numbers',
            minlength: 'Enter minimum 4 numbers'
          },
          confirm: {
            required: ' '
          },
          content: {
            required: 'Please enter your message'
          },
          pname: {
            //error message for the required field
            required: 'Please Enter The Product Name'
          },
          category: {
            required: 'Please Enter category of product '
          },
          price: {
            required: "Please Enter the price of product",
            numeric: "Enther only numbers",
          },
          discription: {
            required: 'Please Enter discription '
          },
          image: {
            required: 'Please choose the image file '
          },
          cname: {
            required: 'Please enter the category '
          }

        },
        submitHandler: function (form) {
          submitForm(); //  ADDED this call
        },

      });
    }
    function submitForm() {
      $("#form").submit((e) => {
        e.preventDefault()
        $.ajax({
          url: '/checkoutSubmit',
          method: 'post',
          data: $('#form').serialize(),
          success: (response) => {
            if (response.codSuccess) {
              location.href = '/success'
            } else if (response.status) {
              razorpayPayment(response)
            } else {

              window.location.href = response.paypalConnection
            }
          }
        })
      })
    }


    function razorpayPayment(order) {
      var options = {
        "key": "rzp_test_B1Edfkjazm7n03", // Enter the Key ID generated from the Dashboard
        "amount": order.amount, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
        "currency": "INR",
        "name": "KIKKI MART",
        "description": "Test Transaction",
        "image": "https://example.com/your_logo",
        "order_id": order.id, //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
        "handler": function (response) {
          verifyPayment(response, order)
        },
        "prefill": {
          "name": "Gaurav Kumar",
          "email": "gaurav.kumar@example.com",
          "contact": "9999999999"
        },
        "notes": {
          "address": "Razorpay Corporate Office"
        },
        "theme": {
          "color": "#3399cc"
        }
      };
      var rzp1 = new Razorpay(options);
      rzp1.open();
    }

    function verifyPayment(payment, order) {
      $.ajax({
        url: '/verifyPayment',
        data: {
          payment,
          order
        },
        method: 'POST',
        success: (response) => {
          if (response.status) {
            location.href = '/success'
          } else {
            alert("Payment Failed")
          }
        }
      })
    }

  </script>
  <script>
    function findAdd(user, add) {
      $.ajax({
        url: '/users/findAddress',
        data: {
          userId: user,
          address: add
        },
        method: 'POST',
        success: (response) => {
          if (response.status) {
            document.getElementById('fname').value = response.address.fname
            document.getElementById('lname').value = response.address.lname
            document.getElementById('country').value = response.address.country
            document.getElementById('housename').value = response.address.housename
            document.getElementById('city').value = response.address.city
            document.getElementById('state').value = response.address.state
            document.getElementById('pincode').value = response.address.pincode
            document.getElementById('mobile').value = response.address.mobile
            document.getElementById('mail').value = response.address.mail
          } else {
            alert("Please add address")
          }
        }
      })
    }
  </script>
</body>